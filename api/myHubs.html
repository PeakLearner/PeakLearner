{% extends "../website/templates/base.jinja2" %}

{% block inner_head %}
    <title>My Hubs</title>

    <link rel="stylesheet" href="../css/hubs.css"/>

    <script type="text/javascript">
        function hubInfoAlert() {
            window.open("/about/");
        }

        // keep scroll position on refresh
        document.addEventListener("DOMContentLoaded", function(event) {
            let showEdit = (sessionStorage.getItem('show_edit') === 'true');
            let showOwned = (sessionStorage.getItem('show_owned') === 'true');
            let showShared = (sessionStorage.getItem('show_shared') === 'true');

            if (!showOwned) {
                let myHubsCheck = document.getElementById('owned-hubs');
                myHubsCheck.checked = false;
            }

            if (!showShared) {
                let sharedHubsCheck = document.getElementById('shared-hubs');
                sharedHubsCheck.checked = false;
            }

            editHubs(showEdit);
            checkHubs();

            let scrollPosition = localStorage.getItem('scrollPosition');
            if (scrollPosition) window.scrollTo(0, scrollPosition);
        });
        window.onbeforeunload = function(e) {
            localStorage.setItem('scrollPosition', window.scrollY);
        };

        function checkHubs() {
            let myHubsCheck = document.getElementById('owned-hubs');
            let sharedHubsCheck = document.getElementById('shared-hubs');

            const myHubs = document.getElementsByClassName("my-hubs");
            if (myHubsCheck.checked) {
                for (let hub = 0; hub < myHubs.length; hub++) {
                    myHubs[hub].style.display = "block";
                    if(myHubs[hub].id === "hubs-break"){
                        myHubs[hub].style.display = "inline"
                    }
                }
                sessionStorage.setItem('show_owned', 'true');
            } else {
                for (let hub = 0; hub < myHubs.length; hub++) {
                    myHubs[hub].style.display = "none";
                }
                sessionStorage.setItem('show_owned', 'false');
            }

            const sharedHubs = document.getElementsByClassName("shared-hubs");
            if (sharedHubsCheck.checked) {
                for (let hub = 0; hub < sharedHubs.length; hub++) {
                    sharedHubs[hub].style.display = "block";
                    if(sharedHubs[hub].id === "hubs-break"){
                        sharedHubs[hub].style.display = "inline"
                    }
                }
                sessionStorage.setItem('show_shared', 'true');
            } else {
                for (let hub = 0; hub < sharedHubs.length; hub++) {
                    sharedHubs[hub].style.display = "none";
                }
                sessionStorage.setItem('show_shared', 'false');
            }
        }

        function editHubs(show) {
            let editElements = document.getElementsByClassName("edit-elements");

            if (show) {
                document.getElementById("stop-edit").style.display = "block";
                document.getElementById("edit").style.display = "none";

                for (let element = 0; element < editElements.length; element++) {
                    editElements[element].style.display = "inline";
                }

                sessionStorage.setItem('show_edit', 'true');
                showEdit = true;
            } else {
                document.getElementById("stop-edit").style.display = "none";
                document.getElementById("edit").style.display = "block";

                for (let element = 0; element < editElements.length; element++) {
                    editElements[element].style.display = "none";
                }

                sessionStorage.setItem('show_edit', 'false');
                showEdit = false;
            }
        }

    </script>

{% endblock %}

{% block content %}
    <div class="d-flex justify-content-center">
        <div class="flex-column">
            <h2 class="text-center">My Hubs</h2>
            <h4 class="text-center">{{ user }}</h4>
        </div>
    </div>

    <hr/>

    <div>
        <div class="float-left" onclick="checkHubs()">
            <form class="form-inline">
                <b style="margin-right: 10px">Filter: </b>
                <div class="form-check form-check-inline rounded" style="padding:5px; background-color: #b22b16">
                    <input class="form-check-input" type="checkbox" value="" id="owned-hubs"
                           checked>
                    <label class="form-check-label" for="owned-hubs" style="color: aliceblue;">
                        Owned Hubs
                    </label>
                </div>
                <div class="form-check form-check-inline bg-secondary rounded" style="padding:5px">
                    <input class="form-check-input" type="checkbox" value="" id="shared-hubs"
                           checked>
                    <label class="form-check-label" for="shared-hubs" style="color: aliceblue;">
                        Shared Hubs
                    </label>
                </div>
            </form>
        </div>

        <div class="float-right">
            <button id="edit" class="btn btn-primary" onclick="editHubs(true)" style="display: block; font-size: 10px;">
                EDIT HUBS
            </button>
            <button id="stop-edit" class="btn btn-danger" onclick="editHubs(false)"
                    style="display: none; font-size: 10px;">FINISH EDITING
            </button>
        </div>
    </div>

    <br><br>

    <ul>
        {% for hub in hubInfos %}

            <li style="list-style-type: none">

                {% if hubInfos[hub]['owner'] == user %}

                    <div class="my-hubs">

                        <div class="card" style="width: 95%;">

                            <div class="card-header" id="myHubHeader">
                                <a class="card-link rounded" id="myHubLink" href="/{{ user }}/{{ hub }}/">
                                    {{ hub }}
                                </a>

                {% else %}

                    <div class="shared-hubs">

                        <div class="card" style="width: 95%;">

                            <div class="card-header" id="otherHubHeader">
                                <a class="card-link rounded" id="otherHubLink" href="/{{ hubInfos[hub]['owner'] }}/{{ hub }}/">
                                    {{ hub }}
                                </a>

                {% endif %}

                                {% if hubInfos[hub]['owner'] == user %}
                                    <form class="edit-elements" action="/deleteHub/" method="post"
                                        style="display:none">
                                        <input value="{{ hub }}" id="hubName" type="hidden" name="hubName">
                                        <button type="submit" class="btn btn-warning" formmethod="post"
                                                style="font-size: 12px; padding: 0 5px; display:inline"> -
                                            Delete Hub
                                        </button>
                                    </form>
                                {% endif %}

                                {% if hubInfos[hub]['owner'] == user or (permissions[(hub, user)] is not none and permissions[(hub, user)][0]) %}
                                    <div class="float-right">
                                        <form class="form-inline" action="/public/{{ hubInfos[hub]['owner'] }}/{{ hub }}/" method="POST">
                                            <div class="form-check form-check-inline">
                                                <label for="chkpublic" style="margin-right: 10px; color:antiquewhite">Public:</label>
                                                <input type="checkbox" name="chkpublic" id="chkpublic" onChange="this.form.submit()"
                                                        {% if hubInfos[hub]['isPublic'] %}
                                                            checked
                                                        {% endif %}
                                                >
                                            </div>
                                        </form>
                                    </div>
                                {% endif %}

                        </div>

                        <div class="card-body">
                            <div class="card-text">
                                <b>Tracks:</b> {{ hubInfos[hub]['tracks']|length }}
                                <br>
                                <b>Labels:</b> {{ labels[hub] }}
                                <br>
                                <a id="hubInfo-showMore" href="/myHubs/{{hub}}/moreInfo/">Show More Hub Info...</a>

                                <hr>

                                <b>Owner:</b> {{ hubInfos[hub]['owner'] }}

                                {% if hubInfos[hub]['owner'] == user or (permissions[(hub, user)] is not none and permissions[(hub, user)][4]) %}

                                    <br>
                                    <b>Users | Permissions:</b>

                                    {% if usersdict[hub] is defined and usersdict[hub]|length > 0 %}

                                        <table class="table table-bordered table-striped table-responsive-md">
                                            <thead class="thead-light">
                                                <th scope="col">User</th>
                                                <th scope="col" class="text-center">Publicity</th>
                                                <th scope="col" class="text-center">Hub</th>
                                                <th scope="col" class="text-center">Labels</th>
                                                <th scope="col" class="text-center">Tracks</th>
                                                <th scope="col" class="text-center">Moderator</th>
                                            </thead>

                                            <tbody>
                                                {% for couser in usersdict[hub] %}
                                                    {% if couser != "Public" and couser != user %}
                                                        <tr>
                                                            <th scope="row">
                                                                <form class="edit-elements float-right" action="/hubRemoveUser/" method="post"
                                                                    style="display:none">
                                                                    <input value="{{ hub }}" id="hubName" type="hidden" name="hubName">
                                                                    <input value="{{ couser }}" id="couserName" type="hidden"
                                                                        name="couserName">
                                                                    <button type="submit" class="btn btn-danger" formmethod="post"
                                                                            style="font-size: 10px; padding: 0 5px; display:inline"> -
                                                                        remove
                                                                    </button>
                                                                </form>

                                                                {{ couser }}
                                                            </th>

                                                            {% if permissions[(hub, couser)] is not none %}
                                                                <form action="/adjustPerms/{{ hubInfos[hub]['owner'] }}/{{ hub }}/{{ couser }}" method="POST">
                                                                    <fieldset>
                                                                        <td class="text-center">
                                                                            <input type="checkbox" name="chkpublic" id="chkpublic" onChange="this.form.submit()"
                                                                                    {% if permissions[(hub, couser)][0] %}
                                                                                        checked
                                                                                    {% endif %}
                                                                            >
                                                                        </td>
                                                                        <td class="text-center">
                                                                            <input type="checkbox" name="chkhub" id="chkhub" onChange="this.form.submit()"
                                                                                    {% if permissions[(hub, couser)][1] %}
                                                                                        checked
                                                                                    {% endif %}
                                                                            >
                                                                        </td>
                                                                        <td class="text-center">
                                                                            <input type="checkbox" name="chklabels" id="chklabels" onChange="this.form.submit()"
                                                                                    {% if permissions[(hub, couser)][2] %}
                                                                                        checked
                                                                                    {% endif %}
                                                                            >
                                                                        </td>
                                                                        <td class="text-center">
                                                                            <input type="checkbox" name="chktracks" id="chktracks" onChange="this.form.submit()"
                                                                                    {% if permissions[(hub, couser)][3] %}
                                                                                        checked
                                                                                    {% endif %}
                                                                            >
                                                                        </td>
                                                                        <td class="text-center">
                                                                            <input type="checkbox" name="chkmoderator" id="chkmoderator" onChange="this.form.submit()"
                                                                                    {% if permissions[(hub, couser)][4] %}
                                                                                        checked
                                                                                    {% endif %}
                                                                            >
                                                                        </td>
                                                                    </fieldset>
                                                                </form>
                                                            {% endif %}
                                                        {% endif %}

                                                    </tr>

                                                {% endfor %}

                                                {% if "Public" in usersdict[hub] %}
                                                    <tr>
                                                        <th scope="row">
                                                            Public
                                                        </th>

                                                        {% if permissions[(hub, 'Public')] is not none %}
                                                            <form action="/adjustPerms/{{ hubInfos[hub]['owner'] }}/{{hub}}/Public" method="POST">
                                                                <fieldset>
                                                                    <td class="text-center">
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="checkbox" name="chkhub" id="chkhub" onChange="this.form.submit()"
                                                                                {% if permissions[(hub, "Public")][1] %}
                                                                                    checked
                                                                                {% endif %}
                                                                        >
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="checkbox" name="chklabels" id="chklabels" onChange="this.form.submit()"
                                                                                {% if permissions[(hub, "Public")][2] %}
                                                                                    checked
                                                                                {% endif %}
                                                                        >
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <input type="checkbox" name="chktracks" id="chktracks" onChange="this.form.submit()"
                                                                                {% if permissions[(hub, "Public")][3] %}
                                                                                    checked
                                                                                {% endif %}
                                                                        >
                                                                    </td>
                                                                    <td class="text-center">
                                                                    </td>
                                                                </fieldset>
                                                            </form>
                                                        {% endif %}

                                                    </tr>

                                                {% endif %}

                                            </tbody>
                                        </table>

                                    {% else %}
                                        No Added Users
                                    {% endif %}

                                {% endif %}

                            </div>

                        {% if hubInfos[hub]['owner'] == user or (permissions[(hub, user)] is not none and permissions[(hub, user)][4]) %}
                            <form class="edit-elements" action="/addUser/" method="POST" style="display: none">
                                <br>
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <label class="input-group-text" id="add-user-label" for="userEmail">
                                            User Email
                                        </label>
                                    </div>
                                    <input type="email" id="userEmail" name="userEmail" class="form-control"
                                            aria-describedby="add-user-label">
                                    <input value="{{ hub }}" id="hubName" type="hidden" name="hubName">
                                    <input class="btn btn-outline-dark" type="submit" value="add user"
                                            style="margin-left: 10px">
                            </form>
                        {% endif %}

                        </div>

                    </div>
                </div>
            </li>

            {% if hubInfos[hub]['owner'] == user %}

            <br class="my-hubs" id="hubs-break">

            {% else %}

            <br class="shared-hubs" id="hubs-break">

            {% endif %}



        {% endfor %}

    </ul>
{% endblock %}
